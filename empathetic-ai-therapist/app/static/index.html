<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Empathetic AI — Voice Therapy Session</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1"></script>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--muted:#6b7280;--accent:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--border:#e6e9ef;--transition:all .2s ease}
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:18px;color:#111;line-height:1.5}
    .container{max-width:1280px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:24px}h1{font-size:24px;font-weight:600;margin:0}
    .hidden{display:none!important}
    .auth-container{max-width:400px;margin:48px auto;background:var(--card);padding:24px;border-radius:12px;border:1px solid var(--border)}
    .auth-form{display:flex;flex-direction:column;gap:16px}.auth-form input{padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px}
    .controls, .session-setup, .recording, .taskbar {display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px;background:var(--card);padding:12px;border-radius:12px;border:1px solid var(--border)}
    button{background:var(--card);border:1px solid var(--border);padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:500;transition:var(--transition);display:flex;align-items:center;justify-content:center;gap:8px;position:relative}
    button.primary{background:var(--accent);color:white;border-color:transparent}
    button.danger{background:var(--danger);color:white;border-color:transparent}
    button.success{background:var(--success);color:white;border-color:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .loader{border:3px solid #f3f3f3;border-top:3px solid var(--accent);border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;display:none}.btn-text{transition:opacity .2s}.loading .loader{display:block}.loading .btn-text{opacity:0}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-box{background:var(--card);padding:24px;border-radius:12px;max-width:500px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.1)}.modal-box h3{margin-bottom:12px;font-size:18px}.modal-box p{margin-bottom:20px;color:var(--muted); text-align: left; white-space: pre-wrap;}.modal-box .modal-actions{display:flex;justify-content:center;gap:12px}
    
    #conversation{background-color:#f9fafb;padding:16px;border-radius:12px;border:1px solid var(--border);height:500px;overflow-y:auto;display:flex;flex-direction:column;gap:20px}
    .turn{display:flex;gap:12px;max-width:85%}.turn.user{align-self:flex-end;flex-direction:row-reverse}.turn.ai{align-self:flex-start}
    .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:white;flex-shrink:0}
    .avatar-ai{background-color:#3b82f6}.avatar-user{background-color:#6366f1}
    .msg-content{display:flex;flex-direction:column;gap:8px; width: 100%;}.speaker{font-weight:600;font-size:14px;color:#4b5563}
    .msg-bubble{padding:12px 16px;border-radius:18px;line-height:1.6;position:relative; width: fit-content;}
    .turn.ai .msg-bubble{background-color:var(--card);border-top-left-radius:4px}.turn.user .msg-bubble{background-color:#eef2ff;border-top-right-radius:4px}
    .meta{font-size:11px;color:var(--muted);padding:0 8px}
    .response-question, .response-task_instruction, .response-metacognitive, .response-CBT, .response-follow_up { font-weight: 600; }
    .response-empathy{font-style:italic;color:#374151}
    .response-suggestion{font-size:14px;color:var(--muted);margin-top:4px}
    .task-instructions{margin-top:12px;padding:10px;background-color:#f0f9ff;border-left:3px solid var(--accent);border-radius:4px;font-size:14px}
    .task-instructions ol{padding-left:20px;margin:0}
    .psychology-note{padding:10px 12px;border-left-width: 4px;border-radius:0 4px 4px 0;font-size:13px;line-height:1.4;margin-top:4px;}.psychology-note::before{content:'💡 The Idea Behind This: ';font-weight:600;display:block;margin-bottom:4px}
    .psychology-note--task { border-color: var(--success); background-color: #f0fdf4; } .psychology-note--task::before { color: #15803d; }
    .psychology-note--follow_up, .psychology-note--metacognitive, .psychology-note--question { border-color: var(--accent); background-color: #eff6ff; } .psychology-note--follow_up::before, .psychology-note--metacognitive::before, .psychology-note--question::before { color: #1d4ed8; }
    .psychology-note--CBT { border-color: var(--warning); background-color: #fffbeb; } .psychology-note--CBT::before { color: #b45309; }
    .psychology-note--safety_crisis { border-color: var(--danger); background-color: #fee2e2; } .psychology-note--safety_crisis::before { color: #b91c1c; }
    .taskbar{justify-content:center;padding:16px}
    #timerBox{display:inline-flex;align-items:center;gap:10px;background:#f0f9ff;padding:6px 12px;border-radius:8px;border:1px solid #bfdbfe;font-size:14px}
    .timer-value{font-weight:600;color:#1e40af}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#dbeafe;color:#1e40af;font-weight:600;font-size:13px}
    .recording-active{animation:pulse 2s infinite}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}70%{box-shadow:0 0 0 10px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
    .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}.status-idle{background:#9ca3af}.status-listening{background:#ef4444}.status-processing{background:#f59e0b}.status-ready{background:#10b981}
    
    /* --- WELLNESS STYLES --- */
    .card{background:var(--card);border-radius:12px;border:1px solid var(--border);margin-bottom:20px; position: relative;}
    .card-header{padding:16px;border-bottom:1px solid var(--border); display: flex; justify-content: space-between; align-items: center;} .card-header h3{margin:0;font-size:16px}
    .card-content{padding:16px}
    .interpret-btn{font-size:12px;color:var(--accent);text-decoration:none;font-weight:500;cursor:pointer}
    .interpret-text{font-size:13px;color:var(--muted);background:#f9fafb;padding:12px;border-radius:8px;margin-top:12px}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px}
    .hourly-logger{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
    .hour-btn{padding:8px;text-align:center;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px}
    .hour-btn:hover{background:#f0f9ff;border-color:var(--accent)}
    .hour-btn.logged{background:var(--success);color:white;border-color:transparent}
    .hour-btn:disabled{background:#e2e8f0;color:#94a3b8;cursor:not-allowed;border-color:var(--border)}
    .hour-btn .loader { border-top-color: var(--accent); width: 14px; height: 14px; border-width: 2px; }
    .insights-grid, .goals-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .insight-card{border-left-width:4px;padding:16px;border-radius:8px}.insight-card h4{margin-bottom:8px;font-size:15px;display:flex;align-items:center;gap:8px}
    .insight-notice{background:#fefce8;border-color:#ca8a04}.insight-notice h4{color:#854d0e}
    .insight-positive{background:#f0fdf4;border-color:var(--success)}.insight-positive h4{color:#15803d}
    .insight-negative{background:#fff1f2;border-color:#f43f5e}.insight-negative h4{color:#be123c}
    .insight-growth{background:#fffbeb;border-color:var(--warning)}.insight-growth h4{color:#b45309}
    .insight-action{background:#eff6ff;border-color:var(--accent)}.insight-action h4{color:#1d4ed8}
    #calendarHeatmap{display:grid;grid-template-columns:repeat(7,1fr);gap:4px; max-width: 200px;}
    .calendar-cell{aspect-ratio:1;border-radius:4px;background:#ebedf0;cursor:pointer;position:relative}
    .calendar-cell:hover{border:2px solid var(--accent)}
    .calendar-cell .tooltip{visibility:hidden;width:160px;background-color:#333;color:#fff;text-align:center;border-radius:6px;padding:5px 0;position:absolute;z-index:1;bottom:125%;left:50%;margin-left:-80px;opacity:0;transition:opacity .3s}
    .calendar-cell:hover .tooltip{visibility:visible;opacity:1}
    #wordCloudContainer{min-height:300px;width:100%}
    .goal-card{background:#faf5ff;border:1px solid #e9d5ff;padding:16px;border-radius:8px; display:flex; flex-direction: column; align-items: flex-start; gap: 8px;}
    .goal-card-content { display: flex; align-items: center; gap: 12px; }
    .goal-card-icon{font-size:24px;} .goal-card p{margin:0;color:#581c87; font-weight: 500;}
    .goal-card .rationale { font-size: 13px; color: var(--muted); margin-left: 36px; }
    .daily-reflection-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-weight: 600; font-size: 14px; }
    .form-group .options { display: flex; flex-wrap: wrap; gap: 8px; }
    .options label { font-weight: normal; font-size: 14px; background: #f1f5f9; padding: 6px 12px; border-radius: 16px; cursor: pointer; border: 1px solid transparent; transition: var(--transition); }
    .options input:checked + label { background: var(--accent); color: white; border-color: var(--accent); }
    .options input { display: none; }
    .food-group { display: flex; align-items: center; justify-content: space-between; }
    .food-group select { padding: 4px; border-radius: 6px; border: 1px solid var(--border); }
    .card-loader-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.7);
        display: flex; align-items: center; justify-content: center;
        z-index: 10; border-radius: 12px;
    }
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="container">
    <header><h1>Empathetic AI</h1></header>
    <div id="authContainer"><!-- Auth Forms --></div>
    <div id="appContainer" class="hidden">
        <div class="controls">
            <button id="showSessionBtn" class="primary">Therapy Session</button>
            <button id="showWellnessBtn">Wellness Tracker</button>
            <button id="logoutBtn" style="margin-left:auto;">Logout</button>
            <button id="endSession" disabled>End Session</button>
            <div id="sessionId" class="small" style="color:var(--muted)">(no active session)</div>
        </div>
        <div id="therapySessionContainer"></div>
        <div id="wellnessContainer" class="hidden"></div>
    </div>
    <footer><p>This is a supportive tool, not a replacement for professional mental health care.</p></footer>
</div>

<script>
let currentUserId = null, sessionId = null, mediaRecorder = null, wellnessData = null, activeTask = null, timerInterval = null, timerRemaining = 0;
let audioChunks = [], charts = {};
const dom = {
    authContainer: document.getElementById('authContainer'), appContainer: document.getElementById('appContainer'),
    loginForm: document.getElementById('loginForm'), signupForm: document.getElementById('signupForm'),
    showSignupLink: document.getElementById('showSignupLink'), showLoginLink: document.getElementById('showLoginLink'),
    logoutBtn: document.getElementById('logoutBtn'),
    showSessionBtn: document.getElementById('showSessionBtn'), showWellnessBtn: document.getElementById('showWellnessBtn'),
    therapyContainer: document.getElementById('therapySessionContainer'), wellnessContainer: document.getElementById('wellnessContainer'),
    sessionIdEl: document.getElementById('sessionId'), endSessionBtn: document.getElementById('endSession'),
};

function showAlert(title, message, type = 'info') {
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) existingModal.remove();
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    const typeColor = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--accent)';
    modal.innerHTML = `
        <div class="modal-box">
            <h3 style="color:${typeColor};">${title}</h3>
            <p>${message}</p>
            <div class="modal-actions">
                <button class="primary" onclick="this.closest('.modal-overlay').remove()">OK</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
}

function showLoader(button, isLoading) {
    if(!button) return;
    button.classList.toggle('loading', isLoading);
    button.disabled = isLoading;
}

function toggleInterpret(el) {
    const textEl = el.nextElementSibling;
    textEl.classList.toggle('hidden');
    el.textContent = textEl.classList.contains('hidden') ? 'How to Interpret ▼' : 'Hide Interpretation ▲';
}

function appendTurn(who, data, meta = null, decision = '') {
    const turnEl = document.createElement('div');
    turnEl.className = `turn ${who}`;
    const avatar = document.createElement('div');
    avatar.className = `avatar avatar-${who}`;
    avatar.textContent = who === 'ai' ? 'AI' : 'You';
    const msgContent = document.createElement('div');
    msgContent.className = 'msg-content';
    const speaker = document.createElement('div');
    speaker.className = 'speaker';
    speaker.textContent = who === 'ai' ? 'AI Therapist' : 'You';
    const msgBubble = document.createElement('div');
    msgBubble.className = 'msg-bubble';
    const replyData = data.reply_structured || {};
    if (who === 'ai' && Array.isArray(replyData.response_parts)) {
        replyData.response_parts.forEach(part => {
            const partEl = document.createElement('div');
            partEl.className = `response-${part.type || 'plain'}`;
            partEl.innerText = part.text;
            msgBubble.appendChild(partEl);
        });
        if (replyData.task_meta?.detail) {
            const instructionsEl = document.createElement('div');
            instructionsEl.className = 'task-instructions';
            const ol = document.createElement('ol');
            const steps = replyData.task_meta.detail.replace(/\d+\.\s*/g, '').split(/;\s*|\.\s*/).filter(s => s.trim());
            steps.forEach(step => { const li = document.createElement('li'); li.textContent = step; ol.appendChild(li); });
            instructionsEl.appendChild(ol);
            msgBubble.appendChild(instructionsEl);
        }
    } else { msgBubble.innerText = data.text || "(no text)"; }
    msgContent.appendChild(speaker);
    msgContent.appendChild(msgBubble);
    if (meta) { const metaEl = document.createElement('div'); metaEl.className = 'meta'; metaEl.textContent = meta; msgContent.appendChild(metaEl); }
    if (who === 'ai' && replyData.psychology_behind_it) {
        const psychEl = document.createElement('div');
        const decisionType = (decision || '').split('+')[1] || (decision || '').split('+')[0];
        psychEl.className = `psychology-note psychology-note--${decisionType}`;
        psychEl.innerText = replyData.psychology_behind_it;
        msgContent.appendChild(psychEl);
    }
    turnEl.appendChild(avatar);
    turnEl.appendChild(msgContent);
    dom.conversation.appendChild(turnEl);
    dom.conversation.scrollTop = dom.conversation.scrollHeight;
    const startTask = () => {
        const timerCard = (replyData.display_cards || []).find(c => c.type === 'timer');
        if (timerCard) {
            const task = { task_id: replyData.task_meta?.task_id || `task_${Date.now()}`, type: replyData.task_meta?.type || 'exercise', detail: replyData.task_meta?.detail || 'Follow spoken instructions.', duration_sec: timerCard.duration_sec };
            startCountdown(timerCard.duration_sec, task);
        }
    };
    if (who === 'ai' && data.tts_b64) {
        try { const audioBlob = new Blob([Uint8Array.from(atob(data.tts_b64), c => c.charCodeAt(0))], { type: 'audio/mpeg' }); const audioUrl = URL.createObjectURL(audioBlob); const audio = new Audio(audioUrl); audio.play().catch(e => { console.warn("TTS playback failed", e); startTask(); }); audio.onended = () => { URL.revokeObjectURL(audioUrl); startTask(); }; } catch (e) { console.warn("TTS processing failed", e); startTask(); }
    } else { startTask(); }
}

function startCountdown(durationSec, task) {
    clearActiveTask();
    timerRemaining = parseInt(durationSec || 0);
    activeTask = task;
    dom.taskControls.classList.remove('hidden');
    if (timerRemaining <= 0) { dom.markDoneBtn.disabled = false; return; }
    dom.timerBox.classList.remove('hidden');
    dom.timerValue.textContent = `${timerRemaining}s`;
    dom.markDoneBtn.disabled = true;
    timerInterval = setInterval(() => {
        timerRemaining -= 1;
        dom.timerValue.textContent = `${timerRemaining}s`;
        if (timerRemaining <= 0) { clearInterval(timerInterval); timerInterval = null; dom.timerValue.textContent = 'Done!'; dom.markDoneBtn.disabled = false; }
    }, 1000);
}

function clearActiveTask() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    if(dom.taskControls) dom.taskControls.classList.add('hidden');
    if(dom.timerBox) dom.timerBox.classList.add('hidden');
    activeTask = null;
    if(dom.markDoneBtn) dom.markDoneBtn.disabled = true;
}

function updateStatus(status, processing=false){
    if(!dom.recStatus || !dom.statusIndicator) return;
    dom.recStatus.textContent = status;
    dom.statusIndicator.className = 'status-indicator';
    if(processing) dom.statusIndicator.classList.add('status-processing');
    else if(status.includes('Recording')) dom.statusIndicator.classList.add('status-listening');
    else dom.statusIndicator.classList.add('status-idle');
}

document.addEventListener('DOMContentLoaded', () => {
    // Populate Auth Container
    dom.authContainer.innerHTML = `<div class="auth-container"><form id="loginForm" class="auth-form"><h2>Welcome Back</h2><input type="text" id="loginUsername" name="username" placeholder="Username" required><input type="password" id="loginPassword" name="password" placeholder="Password" required><button type="submit" class="primary"><span class="btn-text">Login</span><div class="loader"></div></button><div class="form-footer">Don't have an account? <a id="showSignupLink">Create one</a></div></form><form id="signupForm" class="auth-form hidden"><h2>Create Anonymous Account</h2><input type="text" id="signupUsername" name="username" placeholder="Username" required><input type="password" id="signupPassword" name="password" placeholder="Password (min 6 chars)" required><input type="password" id="signupConfirmPassword" name="confirm_password" placeholder="Confirm Password" required><button type="submit" class="primary"><span class="btn-text">Create Account</span><div class="loader"></div></button><div class="form-footer">Already have an account? <a id="showLoginLink">Login</a></div></form></div>`;
    // Populate Therapy Container
    dom.therapyContainer.innerHTML = `<div class="session-setup" id="sessionSetup"><div><label for="languageSelect" class="small">Language:</label><select id="languageSelect"><option value="en-US" selected>English</option><option value="hi-IN">Hindi</option></select></div><div class="gender-options"><span class="small">Your Gender:</span><label><input type="radio" name="userGender" value="female" checked> F</label><label><input type="radio" name="userGender" value="male"> M</label><label><input type="radio" name="userGender" value="other"> O</label></div><button id="startSession" class="primary" style="margin-left: auto;"><span class="btn-text">Start New Session</span><div class="loader"></div></button></div><div class="recording hidden" id="recordingControls"><button id="startRec">Start Recording</button><button id="stopRec" disabled class="danger">Stop Recording</button><button id="submitRec" disabled class="primary"><span class="btn-text">Submit</span><div class="loader"></div></button><div style="margin-left: auto; display: flex; align-items: center; gap: 6px;"><span class="status-indicator status-idle" id="statusIndicator"></span><span id="recStatus" class="small">Ready</span></div></div><div id="conversation"></div><div class="taskbar hidden" id="taskControls"><button id="markDone" class="success" disabled><span class="btn-text">I'm Done</span><div class="loader"></div></button><div id="timerBox" class="hidden"><span class="chip">Timer</span><span class="timer-value" id="timerValue">60s</span></div></div>`;
    // Populate Wellness Container
    dom.wellnessContainer.innerHTML = `
        <h2 style="font-size:22px; margin-bottom:20px;">Your Wellness Dashboard</h2>
        <div class="card"><div class="card-header"><h3>Daily Logging</h3></div><div class="card-content">
            <h4>Part 1: Quick Thoughts</h4><p class="small" style="margin-bottom:12px;">How are you feeling? Click an hour to log your thoughts and emotions. Logged hours are disabled.</p><div class="hourly-logger" id="hourlyLogger"></div>
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
            <h4>Part 2: Daily Reflection</h4><p class="small" style="margin-bottom:12px;">Fill this out once per day to find deeper patterns.</p><form id="dailyReflectionForm" class="daily-reflection-form"></form>
        </div></div>
        <div class="card"><div class="card-header"><h3>This Week's Goals</h3></div><div class="card-content goals-grid" id="goalsContainer"></div></div>
        <div class="card"><div class="card-header"><h3>AI-Powered Insights</h3></div><div class="card-content"><div class="insights-grid" id="insightsContainer"></div></div></div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Sleep Quality vs. Sentiment</h3></div><div class="card-content"><canvas id="sleepChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret ▼</a><div class="interpret-text hidden">This chart shows your average mood based on sleep quality. For example, a high bar for "Good" sleep suggests that when you sleep well, you tend to feel better.</div></div></div>
            <div class="card"><div class="card-header"><h3>Activity vs. Sentiment</h3></div><div class="card-content"><canvas id="activityChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret ▼</a><div class="interpret-text hidden">This compares how different activities correlate with your mood. It can help you identify which activities are restorative and which might be draining.</div></div></div>
        </div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Social vs. Sentiment</h3></div><div class="card-content"><canvas id="socialChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret ▼</a><div class="interpret-text hidden">This chart shows the connection between who you spend time with and your overall mood, helping you understand your social energy.</div></div></div>
            <div class="card"><div class="card-header"><h3>Sentiment Over Time</h3></div><div class="card-content"><canvas id="sentimentOverTimeChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret ▼</a><div class="interpret-text hidden">This line chart tracks your average daily mood. Upward trends indicate periods of positivity, while downward trends might highlight challenging times. It helps you see your emotional journey at a glance.</div></div></div>
        </div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Emotion Distribution</h3></div><div class="card-content"><canvas id="emotionDistributionChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret ▼</a><div class="interpret-text hidden">This chart shows the percentage of each emotion you've logged. It gives a high-level overview of your most frequent feelings. Are there any surprises here?</div></div></div>
            <div class="card"><div class="card-header"><h3>Topic Word Cloud</h3></div><div class="card-content"><div id="wordCloudContainer"></div><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret ▼</a><div class="interpret-text hidden">The bigger the word, the more often it appears in your logs. This helps you quickly see the topics that are on your mind the most, offering clues about what drives your emotions.</div></div></div>
        </div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Daily Sentiment (Last 30 Days)</h3></div><div class="card-content"><div id="calendarHeatmap"></div><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret ▼</a><div class="interpret-text hidden">Greener days are more positive, redder days are more negative. Click any day to get an AI-generated summary of your logs for that day.</div></div></div>
            <div class="card"><div class="card-header"><h3>Recent Session Summaries</h3></div><div class="card-content"><ul class="session-summary-list" id="sessionSummaryList">(No session summaries found)</ul></div></div>
        </div>
        `;

    // Re-assign all DOM elements
    Object.assign(dom, {
        loginForm: document.getElementById('loginForm'), signupForm: document.getElementById('signupForm'), showSignupLink: document.getElementById('showSignupLink'), showLoginLink: document.getElementById('showLoginLink'), sessionSetup: document.getElementById('sessionSetup'), languageSelect: document.getElementById('languageSelect'), startSessionBtn: document.getElementById('startSession'), recordingControls: document.getElementById('recordingControls'), startRecBtn: document.getElementById('startRec'), stopRecBtn: document.getElementById('stopRec'), submitRecBtn: document.getElementById('submitRec'), conversation: document.getElementById('conversation'), statusIndicator: document.getElementById('statusIndicator'), recStatus: document.getElementById('recStatus'), taskControls: document.getElementById('taskControls'), markDoneBtn: document.getElementById('markDone'), timerBox: document.getElementById('timerBox'), timerValue: document.getElementById('timerValue'), hourlyLogger: document.getElementById('hourlyLogger'), insightsContainer: document.getElementById('insightsContainer'), goalsContainer: document.getElementById('goalsContainer'), dailyReflectionForm: document.getElementById('dailyReflectionForm'), sessionSummaryList: document.getElementById('sessionSummaryList'), calendarHeatmap: document.getElementById('calendarHeatmap'), wordCloudContainer: document.getElementById('wordCloudContainer')
    });
    
    // Attach event listeners
    dom.showSignupLink.onclick = () => { dom.loginForm.classList.add('hidden'); dom.signupForm.classList.remove('hidden'); };
    dom.showLoginLink.onclick = () => { dom.signupForm.classList.add('hidden'); dom.loginForm.classList.remove('hidden'); };
    dom.signupForm.onsubmit = onSignup;
    dom.loginForm.onsubmit = onLogin;
    dom.logoutBtn.onclick = onLogout;
    dom.showSessionBtn.onclick = () => { dom.therapyContainer.classList.remove('hidden'); dom.wellnessContainer.classList.add('hidden'); dom.showSessionBtn.classList.add('primary'); dom.showWellnessBtn.classList.remove('primary'); };
    dom.showWellnessBtn.onclick = () => { dom.therapyContainer.classList.add('hidden'); dom.wellnessContainer.classList.remove('hidden'); dom.showWellnessBtn.classList.add('primary'); dom.showSessionBtn.classList.remove('primary'); if (!wellnessData) fetchAndRenderWellnessData(); };
    dom.startSessionBtn.onclick = onStartSession;
    dom.endSessionBtn.onclick = onEndSession;
    dom.startRecBtn.onclick = onStartRecording;
    dom.stopRecBtn.onclick = onStopRecording;
    dom.submitRecBtn.onclick = onSubmitRecording;
    dom.markDoneBtn.onclick = onTaskDone;
    dom.dailyReflectionForm.onsubmit = onSaveStructuredData;
});

// --- AUTH & SESSION FUNCTIONS ---
async function onSignup(e) { e.preventDefault(); const btn = dom.signupForm.querySelector('button'); showLoader(btn, true); try { const form = new FormData(dom.signupForm); const res = await fetch('/signup', { method: 'POST', body: form }); const data = await res.json(); if (!res.ok) throw new Error(data.detail); showAlert('Success', 'Account created. Please log in.', 'success'); dom.signupForm.reset(); dom.showLoginLink.onclick(); } catch (err) { showAlert('Signup Error', err.message, 'error'); } finally { showLoader(btn, false); } }
async function onLogin(e) { e.preventDefault(); const btn = dom.loginForm.querySelector('button'); showLoader(btn, true); try { const form = new FormData(dom.loginForm); const res = await fetch('/login', { method: 'POST', body: form }); const data = await res.json(); if (!res.ok) throw new Error(data.detail); currentUserId = data.user_id; dom.authContainer.classList.add('hidden'); dom.appContainer.classList.remove('hidden'); dom.showSessionBtn.click(); } catch (err) { showAlert('Login Error', err.message, 'error'); } finally { showLoader(btn, false); } }
function onLogout() { if(sessionId) onEndSession(); currentUserId=null; sessionId=null; wellnessData=null; dom.appContainer.classList.add('hidden'); dom.authContainer.classList.remove('hidden'); dom.loginForm.reset(); dom.signupForm.reset(); dom.conversation.innerHTML=''; dom.endSessionBtn.disabled=true; clearActiveTask(); }
async function onStartSession() { showLoader(dom.startSessionBtn, true); updateStatus("Starting...", true); try { const form=new FormData(); form.append('user_id', currentUserId); form.append('language', dom.languageSelect.value); form.append('user_gender', document.querySelector('input[name="userGender"]:checked').value); const res = await fetch('/start_session', {method:'POST', body: form}); if(!res.ok) throw new Error(await res.text()); const j = await res.json(); sessionId = j.session_id; dom.sessionSetup.classList.add('hidden'); dom.recordingControls.classList.remove('hidden'); dom.sessionIdEl.textContent = `Session: ...${sessionId.slice(-6)}`; dom.conversation.innerHTML = ""; appendTurn('ai', { reply_structured: j.initial_reply, tts_b64: j.tts_b64 }, "Session started", "start"); dom.endSessionBtn.disabled = false; wellnessData = null; clearActiveTask(); updateStatus("Ready", false); } catch(e) { showAlert('Error', e.message, 'error'); updateStatus("Error", false); } finally { showLoader(dom.startSessionBtn, false); } }
async function onEndSession() { if(!sessionId) return; showLoader(dom.endSessionBtn, true); updateStatus("Ending...", true); try { const form=new FormData(); form.append('session_id', sessionId); const res = await fetch('/end_session',{method:'POST',body:form}); const j = await res.json(); appendTurn('ai',{reply_structured: j.closing_reply,tts_b64:j.tts_b64},"Session ended", "end"); sessionId=null; dom.sessionIdEl.textContent="(no active session)"; dom.sessionSetup.classList.remove('hidden'); dom.recordingControls.classList.add('hidden'); dom.endSessionBtn.disabled=true; clearActiveTask();} catch(e) { showAlert('Error', `Could not end session: ${e.message}`, 'error'); } finally { showLoader(dom.endSessionBtn, false); updateStatus("Ended", false); } }
async function onStartRecording() { updateStatus("Requesting mic...", true); audioChunks = []; try { const stream = await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder = new MediaRecorder(stream); mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); }; mediaRecorder.onstop = () => { updateStatus("Stopped", false); dom.submitRecBtn.disabled = false; }; mediaRecorder.start(); dom.startRecBtn.disabled = true; dom.stopRecBtn.disabled = false; dom.startRecBtn.classList.add('recording-active'); updateStatus("Recording...", false); } catch (e) { showAlert('Mic Error', e.message, 'error'); updateStatus("Mic Error", false); } }
function onStopRecording() { if(mediaRecorder?.state === "recording"){ mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t => t.stop()); dom.startRecBtn.disabled = false; dom.stopRecBtn.disabled = true; dom.startRecBtn.classList.remove('recording-active'); } }
async function onSubmitRecording() { if(!audioChunks.length || !sessionId) return; showLoader(dom.submitRecBtn, true); updateStatus("Processing...", true); try { const blob = new Blob(audioChunks, {type:'audio/webm'}); const form = new FormData(); form.append('file', blob, 'rec.webm'); form.append('session_id', sessionId); const res = await fetch('/process_audio', {method:'POST', body:form}); if(!res.ok) throw new Error((await res.json()).detail); const j = await res.json(); appendTurn('user', {text: j.audio_output.transcript || "(silence)"}, `Emotion: ${j.audio_output.final_emotion}`); appendTurn('ai', {reply_structured: j.reply, tts_b64: j.tts_b64}, `Decision: ${j.decision.decision}`, j.decision.decision); audioChunks = []; dom.submitRecBtn.disabled = true; } catch(e) { showAlert('Error', e.message, 'error'); } finally { showLoader(dom.submitRecBtn, false); updateStatus("Ready", false); } }
async function onTaskDone() { if(!sessionId || !activeTask) return; showLoader(dom.markDoneBtn, true); try { const form = new FormData(); form.append('session_id', sessionId); form.append('task_id', activeTask.task_id); const res = await fetch('/task_done', {method:'POST', body:form}); if(!res.ok) throw new Error(await res.text()); const j = await res.json(); appendTurn('ai', {reply_structured: j.reply, tts_b64: j.tts_b64}, 'Follow-up', j.decision.decision); } catch(e) { showAlert('Task Error', e.message, 'error'); } finally { showLoader(dom.markDoneBtn, false); clearActiveTask(); } }
async function onSaveStructuredData(e) { e.preventDefault(); const btn = dom.dailyReflectionForm.querySelector('button'); showLoader(btn, true); try { const form = new FormData(dom.dailyReflectionForm); form.append('user_id', currentUserId); form.append('date_str', new Date().toISOString().split('T')[0]); const res = await fetch('/wellness/log_structured_entry', { method: 'POST', body: form }); if (!res.ok) throw new Error(await res.text()); showAlert('Success', 'Reflection saved.', 'success'); wellnessData = null; fetchAndRenderWellnessData(); } catch(e) { showAlert('Error', e.message, 'error'); } finally { showLoader(btn, false); } }

// --- WELLNESS DASHBOARD FUNCTIONS ---
async function fetchAndRenderWellnessData() {
    showLoader(dom.showWellnessBtn, true);
    const wellnessCards = dom.wellnessContainer.querySelectorAll('.card');
    wellnessCards.forEach(card => {
        const overlay = document.createElement('div');
        overlay.className = 'card-loader-overlay';
        overlay.innerHTML = `<div class="loader" style="display:block; width: 40px; height: 40px; border-width: 4px;"></div>`;
        card.appendChild(overlay);
    });

    try {
        const form = new FormData(); form.append('user_id', currentUserId);
        const res = await fetch('/wellness/get_wellness_data', { method: 'POST', body: form });
        if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Failed to fetch data.'); }
        wellnessData = await res.json();
        const { raw_logs, summaries, aggregated_data, insights } = wellnessData;
        renderDailyLogging(raw_logs);
        renderSummaries(summaries);
        renderInsights(insights);
        renderGoals(insights.weekly_goals);
        renderCalendarHeatmap(aggregated_data.daily_sentiment);
        renderAllCharts(aggregated_data);
    } catch (e) { showAlert('Dashboard Error', e.message, 'error'); } 
    finally { 
        showLoader(dom.showWellnessBtn, false); 
        wellnessCards.forEach(card => {
            const overlay = card.querySelector('.card-loader-overlay');
            if (overlay) overlay.remove();
        });
    }
}

function renderDailyLogging(logs) {
    dom.hourlyLogger.innerHTML = '';
    const todayStr = new Date().toISOString().split('T')[0];
    const todaysTextLogs = logs.filter(l => l.type === 'hourly_text' && l.log_date_local === todayStr);
    for (let i = 0; i < 24; i++) {
        const btn = document.createElement('button');
        btn.className = 'hour-btn';
        btn.innerHTML = `<span class="btn-text">${i}:00</span><div class="loader"></div>`; 
        const existingLog = todaysTextLogs.find(l => l.log_hour_local === i);
        if (existingLog) { btn.classList.add('logged'); btn.title = `Logged: ${existingLog.analysis.primary_emotion}`; btn.disabled = true; }
        btn.onclick = (e) => logForHour(i, existingLog, e.currentTarget);
        dom.hourlyLogger.appendChild(btn);
    }
    const todaysStructuredLog = logs.find(l => l.type === 'structured' && l.log_date_local === todayStr);
    renderStructuredForm(todaysStructuredLog);
}

function logForHour(hour, existingLog, buttonEl) { const text = prompt(`How are you feeling at ${hour}:00?`); if (text?.trim()) submitHourlyLog(hour, text.trim(), buttonEl); }

// MODIFIED: This function no longer reloads the entire page. It updates the button and local data directly.
async function submitHourlyLog(hour, text, buttonEl) { 
    showLoader(buttonEl, true);
    const form = new FormData(); 
    form.append('user_id', currentUserId); 
    form.append('hour', hour); 
    form.append('text', text); 
    form.append('date_str', new Date().toISOString().split('T')[0]); 
    try { 
        const res = await fetch('/wellness/log_daily_entry', { method: 'POST', body: form }); 
        if (!res.ok) {
             const errorData = await res.json();
             throw new Error(errorData.detail || 'Failed to submit log.');
        }
        const result = await res.json();
        const newLog = result.data;

        // Update UI for this specific button
        buttonEl.classList.add('logged');
        buttonEl.disabled = true;
        buttonEl.title = `Logged: ${newLog.analysis.primary_emotion}`;
        
        // Update local cache without full reload
        if (wellnessData && wellnessData.raw_logs) {
            wellnessData.raw_logs.push(newLog);
        }
        
        // No full fetchAndRenderWellnessData() call needed here.
        // showAlert('Success', 'Entry logged.', 'success'); // Optional: can be annoying if logging many.
    } catch(e) { 
        showAlert('Log Error', e.message, 'error'); 
    } finally {
        showLoader(buttonEl, false);
    }
}

function renderSummaries(summaries) { dom.sessionSummaryList.innerHTML = (!summaries || summaries.length === 0) ? '<li>(No recent session summaries)</li>' : summaries.map(s => `<li class="session-summary-item" style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);"><h5>${s.title || 'Session Summary'}</h5><p class="small" style="color:var(--muted);">${new Date(s.session_start_utc).toLocaleString()}</p><p style="font-size: 14px;">${s.overall_summary || ''}</p></li>`).join(''); }

function renderStructuredForm(log) {
    const data = log ? log.data : {};
    const social = data.social_interactions || [];
    const activities = data.activities || [];
    const food = data.food_intake || {};
    const fields = {
        sleep_quality: { label: 'How was your sleep quality?', options: ['Good', 'OK', 'Poor'], type: 'radio' },
        social_interactions: { label: 'Who did you spend most time with?', options: ['Family', 'Partner', 'Friends', 'Alone'], type: 'checkbox' },
        activities: { label: 'What activities did you do?', options: ['Work', 'Exercise', 'Hobby', 'Relax', 'Lazy'], type: 'checkbox' }
    };
    let formHTML = '';
    for (const [key, val] of Object.entries(fields)) {
        formHTML += `<div class="form-group"><label>${val.label}</label><div class="options">`;
        val.options.forEach(opt => {
            const checked = val.type === 'radio' ? (data[key] === opt ? 'checked' : '') : (data[key]?.includes(opt) ? 'checked' : '');
            formHTML += `<input type="${val.type}" name="${key}" value="${opt}" id="${key}_${opt}" ${checked} ${log ? 'disabled' : ''}><label for="${key}_${opt}">${opt}</label>`;
        });
        formHTML += `</div></div>`;
    }
    formHTML += `<div class="form-group"><label>Food Intake Quality</label>
        <div class="food-group"><span>Breakfast:</span> <select name="food_breakfast" ${log ? 'disabled' : ''}><option ${food.breakfast === 'Healthy' ? 'selected' : ''}>Healthy</option><option ${food.breakfast === 'Semi' ? 'selected' : ''}>Semi</option><option ${food.breakfast === 'Junk' ? 'selected' : ''}>Junk</option></select></div>
        <div class="food-group"><span>Lunch:</span> <select name="food_lunch" ${log ? 'disabled' : ''}><option ${food.lunch === 'Healthy' ? 'selected' : ''}>Healthy</option><option ${food.lunch === 'Semi' ? 'selected' : ''}>Semi</option><option ${food.lunch === 'Junk' ? 'selected' : ''}>Junk</option></select></div>
        <div class="food-group"><span>Dinner:</span> <select name="food_dinner" ${log ? 'disabled' : ''}><option ${food.dinner === 'Healthy' ? 'selected' : ''}>Healthy</option><option ${food.dinner === 'Semi' ? 'selected' : ''}>Semi</option><option ${food.dinner === 'Junk' ? 'selected' : ''}>Junk</option></select></div>
    </div>`;
    if (!log) { formHTML += `<button type="submit" class="primary" style="grid-column: 1 / -1; margin-top: 12px;"><span class="btn-text">Save Daily Reflection</span><div class="loader"></div></button>`; } 
    else { formHTML += `<p style="grid-column: 1 / -1; text-align: center; color: var(--muted); margin-top: 12px;">Today's reflection has been saved.</p>`; }
    dom.dailyReflectionForm.innerHTML = formHTML;
}

function renderInsights(insights) { dom.insightsContainer.innerHTML = `
    <div class="insight-card insight-notice"><h4>✨ We've Noticed...</h4><p>${insights.causal_inference || 'N/A'}</p></div>
    <div class="insight-card insight-positive"><h4>✅ Positive Pattern</h4><p>${insights.positive_pattern || 'N/A'}</p></div>
    <div class="insight-card insight-negative"><h4>⚠️ Challenge Pattern</h4><p>${insights.challenge_pattern || 'N/A'}</p></div>
    <div class="insight-card insight-growth"><h4>🌱 Area for Growth</h4><p>${insights.area_for_growth || 'N/A'}</p></div>
    <div class="insight-card insight-action" style="grid-column: 1 / -1;"><h4>💡 Actionable Suggestion</h4><p>${insights.actionable_suggestion || 'N/A'}</p></div>`;
}

function renderGoals(goals) { 
    dom.goalsContainer.innerHTML = (goals && goals.length > 0) ? goals.map(g => `
        <div class="goal-card">
            <div class="goal-card-content">
                <span class="goal-card-icon">🎯</span>
                <p>${g.goal}</p>
            </div>
            ${g.rationale ? `<div class="rationale">${g.rationale}</div>` : ''}
        </div>`).join('') : '<p>Your personalized goals will appear here soon.</p>'; 
}

const getSentimentColor = s => { if (s === null || s === undefined) return '#ebedf0'; const r = s < 0 ? 239 : 190, g = s > 0 ? 246 : 222, b = 239, a = Math.abs(s) * .8 + .2; return `rgba(${r}, ${g}, ${b}, ${a})`;};
async function renderCalendarHeatmap(dailySentiments) {
    dom.calendarHeatmap.innerHTML = '';
    const today = new Date();
    const startDate = new Date();
    startDate.setDate(today.getDate() - 29);
    for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        cell.style.backgroundColor = getSentimentColor(dailySentiments[dateStr]);
        cell.onclick = async () => {
            const logsForDay = (wellnessData.raw_logs || []).filter(l => l.type === 'hourly_text' && l.log_date_local === dateStr);
            showAlert(`Summary for ${dateStr}`, 'Generating summary...', 'info');
            try {
                const res = await fetch('/wellness/summarize_day_logs', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: currentUserId, logs: logsForDay }) });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showAlert(`Summary for ${dateStr}`, data.summary, 'info');
            } catch (e) { showAlert('Error', `Could not generate summary: ${e.message}`, 'error'); }
        };
        cell.innerHTML = `<span class="tooltip">${dateStr}<br>Sentiment: ${dailySentiments[dateStr]?.toFixed(2) || 'N/A'}<br><b>Click for summary</b></span>`;
        dom.calendarHeatmap.appendChild(cell);
    }
}
function renderAllCharts(aggregated) {
    const chartColors = ['#2563eb', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#3b82f6', '#f97316', '#22c55e', '#ec4899'];
    const correlationMetrics = aggregated.correlation_metrics || {};

    renderCorrelationChart('sleepChart', correlationMetrics.sleep_quality, 'Avg. Sentiment by Sleep Quality', chartColors);
    renderCorrelationChart('activityChart', correlationMetrics.activity, 'Avg. Sentiment by Activity', chartColors);
    renderCorrelationChart('socialChart', correlationMetrics.social, 'Avg. Sentiment by Social Interaction', chartColors);

    if (charts.emotion) charts.emotion.destroy();
    const emotionCtx = document.getElementById('emotionDistributionChart').getContext('2d');
    const emotionData = aggregated.emotion_counts || {};
    charts.emotion = new Chart(emotionCtx, { type: 'pie', data: { labels: Object.keys(emotionData), datasets: [{ data: Object.values(emotionData), backgroundColor: chartColors }] }});

    if (charts.sentiment) charts.sentiment.destroy();
    const sentimentCtx = document.getElementById('sentimentOverTimeChart').getContext('2d');
    const dailyData = aggregated.daily_sentiment || {};
    const sortedDates = Object.keys(dailyData).sort();
    charts.sentiment = new Chart(sentimentCtx, { type: 'line', data: { labels: sortedDates, datasets: [{ label: 'Average Sentiment', data: sortedDates.map(d => dailyData[d]), borderColor: 'rgba(37, 99, 235, 0.8)', tension: 0.1, fill: false }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { min: -1, max: 1 } } } });
    
    dom.wordCloudContainer.innerHTML = '';
    const words = (aggregated.word_cloud_data || []).map(d => ({text: d.text, size: 10 + Math.pow(d.value, 0.7) * 10}));
    if (words.length > 0) {
        const color = d3.scaleOrdinal(d3.schemeTableau10);
        const layout = d3.layout.cloud().size([dom.wordCloudContainer.clientWidth > 0 ? dom.wordCloudContainer.clientWidth : 300, 300]).words(words).padding(5).rotate(() => 0).fontSize(d => d.size).on("end", draw);
        layout.start();
        function draw(words) { d3.select("#wordCloudContainer").append("svg").attr("width", layout.size()[0]).attr("height", layout.size()[1]).append("g").attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")").selectAll("text").data(words).enter().append("text").style("font-size", d => d.size + "px").style("font-family", "Inter").style("fill", (d,i) => color(i)).attr("text-anchor", "middle").attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")").text(d => d.text); }
    }
}
function renderCorrelationChart(canvasId, data, label, colors) {
    if(!data || Object.keys(data).length === 0) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();
        ctx.font = "14px Inter";
        ctx.fillStyle = "#9ca3af";
        ctx.textAlign = "center";
        ctx.fillText("Not enough data to show this chart yet.", ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    };
    if (charts[canvasId]) charts[canvasId].destroy();
    const ctx = document.getElementById(canvasId).getContext('2d');
    charts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(data), datasets: [{ label: label, data: Object.values(data), backgroundColor: colors }] }, options: { scales: { y: { min: -1, max: 1 } }, indexAxis: 'y', plugins: { legend: { display: false } } } });
}
</script>
</body>
</html>