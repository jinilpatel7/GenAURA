<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HealAura - Your AI Wellness Companion</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1"></script>
  <style>
    :root{
      --bg: #f9f9f7;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #ddea6d; /* Vibrant Lime */
      --accent-dark: #c8d75a;
      --accent-light: #f5f8e5;
      --success: #68d391; /* Soft Green */
      --warning: #f6ad55; /* Soft Orange */
      --danger: #f08080; /* Light Coral */
      --growth: #81e6d9; /* Aqua for Growth */
      --border: #e5e7eb;
      --text-primary: #2c2c2c;
      --text-secondary: #555555;
      --transition: all .3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--text-primary);
      line-height:1.6;
    }
    
    .container{max-width:1320px;margin:0 auto}
    
    header{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:32px;
      padding:24px;
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--shadow-md);
      border:1px solid var(--border);
    }
    
    h1{
      font-size:28px;
      font-weight:700;
      margin:0;
      color:var(--text-primary);
      background:linear-gradient(135deg, var(--accent-dark) 0%, var(--accent) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    
    .tagline{
      font-size:14px;
      color:var(--text-secondary);
      margin-top:4px;
      line-height:1.4;
      max-width:600px;
    }
    
    .hidden{display:none!important}
    
    .auth-container{
      max-width:440px;
      margin:60px auto;
      background:var(--card);
      padding:32px;
      border-radius:24px;
      border:1px solid var(--border);
      box-shadow:var(--shadow-lg);
    }
    
    .auth-form{display:flex;flex-direction:column;gap:20px}
    .auth-form h2{
      font-size:24px;
      font-weight:700;
      color:var(--text-primary);
      text-align:center;
      margin-bottom:8px;
    }
    
    .auth-form input{
      padding:14px 18px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:15px;
      background: var(--bg);
      transition:var(--transition);
      color:var(--text-primary);
    }
    
    .auth-form input:focus{
      outline:none;
      border-color:var(--accent);
      background:white;
      box-shadow:0 0 0 3px rgba(221, 234, 109, 0.3);
    }
    
    .form-footer{
      text-align:center;
      color:var(--text-secondary);
      font-size:14px;
    }
    
    .form-footer a{
      color:var(--accent-dark);
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
      transition:var(--transition);
    }
    
    .form-footer a:hover{
      text-decoration:underline;
    }
    
    .controls, .session-setup, .recording, .taskbar {
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:20px;
      background:var(--card);
      padding:16px 20px;
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:var(--shadow-sm);
    }
    
    button{
      background:var(--card);
      border:1px solid #dcdcdc;
      padding:12px 20px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:var(--transition);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      font-size:15px;
      color:var(--text-primary);
      box-shadow:var(--shadow-sm);
    }
    
    button:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
      border-color: var(--accent-dark);
    }
    
    button.primary{
      background:var(--accent);
      color:var(--text-primary);
      border-color:transparent;
    }
    
    button.primary:hover:not(:disabled){
      background:var(--accent-dark);
    }
    
    button.danger{
      background:var(--danger);
      color:white;
      border-color:transparent;
    }
    
    button.success{
      background:var(--success);
      color:white;
      border-color:transparent;
    }
    
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    
    .loader{
      border:3px solid rgba(0, 0, 0, 0.1);
      border-top:3px solid var(--text-primary);
      border-radius:50%;
      width:20px;
      height:20px;
      animation:spin 1s linear infinite;
      display:none;
    }
    
    button.primary .loader { border-top-color: var(--text-primary); }
    button.danger .loader, button.success .loader { border: 3px solid rgba(255,255,255,0.2); border-top-color: white; }

    .btn-text{transition:opacity .2s}
    .loading .loader{display:block}
    .loading .btn-text{opacity:0}
    
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(4px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    
    .modal-box{
      background:var(--card);
      padding:32px;
      border-radius:20px;
      max-width:520px;
      text-align:center;
      box-shadow:var(--shadow-lg);
      border:1px solid var(--border);
    }
    
    .modal-box h3{
      margin-bottom:16px;
      font-size:20px;
      font-weight:700;
    }
    
    .modal-box p{
      margin-bottom:24px;
      color:var(--text-secondary);
      text-align:left;
      white-space:pre-wrap;
      line-height:1.6;
    }
    
    .modal-box .modal-actions{
      display:flex;
      justify-content:center;
      gap:16px;
    }
    
    /* Gender Selection Buttons */
    .gender-options{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .gender-options span{
      font-weight:600;
      color:var(--text-secondary);
      margin-right:8px;
    }
    
    .gender-btn{
      position:relative;
      display:inline-block;
    }
    
    .gender-btn input[type="radio"]{
      position:absolute;
      opacity:0;
    }
    
    .gender-btn label{
      display:inline-block;
      padding:10px 20px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:var(--transition);
      color:var(--text-secondary);
    }
    
    .gender-btn input:checked + label{
      background:var(--accent);
      border-color:transparent;
      color:var(--text-primary);
      box-shadow:var(--shadow-sm);
    }
    
    .gender-btn label:hover{
      border-color:var(--accent);
    }
    
    #conversation{
      background: var(--bg);
      padding:24px;
      border-radius:20px;
      border:1px solid var(--border);
      height:520px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:24px;
      box-shadow:inset 0 2px 4px 0 rgba(0,0,0,0.05);
    }
    
    /* Custom Scrollbar */
    #conversation::-webkit-scrollbar,
    .session-summary-list::-webkit-scrollbar {
      width:8px;
    }
    
    #conversation::-webkit-scrollbar-track,
    .session-summary-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius:10px;
    }
    
    #conversation::-webkit-scrollbar-thumb,
    .session-summary-list::-webkit-scrollbar-thumb {
      background:var(--accent);
      border-radius:10px;
    }
    
    #conversation::-webkit-scrollbar-thumb:hover,
    .session-summary-list::-webkit-scrollbar-thumb:hover {
      background:var(--accent-dark);
    }
    
    .turn{
      display:flex;
      gap:16px;
      max-width:85%;
    }
    
    .turn.user{
      align-self:flex-end;
      flex-direction:row-reverse;
    }
    
    .turn.ai{
      align-self:flex-start;
    }
    
    .avatar{
      width:44px;
      height:44px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:var(--text-primary);
      flex-shrink:0;
      box-shadow:var(--shadow-sm);
      font-size:14px;
    }
    
    .avatar-ai{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    }
    
    .avatar-user{
      background:linear-gradient(135deg, #a7c5d7 0%, #87a7b9 100%);
      color: white;
    }
    
    .msg-content{
      display:flex;
      flex-direction:column;
      gap:10px;
      width:100%;
    }
    
    .speaker{
      font-weight:700;
      font-size:14px;
      color:var(--text-secondary);
    }
    
    .msg-bubble{
      padding:16px 20px;
      border-radius:20px;
      line-height:1.7;
      position:relative;
      width:fit-content;
      box-shadow:var(--shadow-sm);
    }
    
    .turn.ai .msg-bubble{
      background:var(--card);
      border-top-left-radius:4px;
      border:1px solid var(--border);
    }
    
    .turn.user .msg-bubble{
      background:var(--accent-light);
      border-top-right-radius:4px;
      color:var(--text-primary);
    }
    
    .meta{
      display: none; /* HIDE META TEXT */
    }
    
    .response-question, .response-task_instruction, .response-metacognitive, .response-CBT, .response-follow_up {
      font-weight:700;
      color:var(--text-primary);
    }
    
    .response-empathy{
      font-style:italic;
      color:var(--text-secondary);
    }
    
    .response-suggestion{
      font-size:14px;
      color:var(--muted);
      margin-top:6px;
    }
    
    .task-instructions{
      margin-top:16px;
      padding:16px;
      background:var(--accent-light);
      border-left:4px solid var(--accent);
      border-radius:8px;
      font-size:15px;
    }
    
    .task-instructions ol{
      padding-left:24px;
      margin:0;
      color:var(--text-secondary);
    }
    
    .psychology-note{
      padding:14px 16px;
      border-left-width:4px;
      border-radius:0 8px 8px 0;
      font-size:14px;
      line-height:1.5;
      margin-top:8px;
    }
    
    .psychology-note::before{
      content:'ðŸ’¡ The Idea Behind This: ';
      font-weight:700;
      display:block;
      margin-bottom:6px;
    }
    
    .psychology-note--task {
      border-color:var(--success);
      background:rgba(104, 211, 145, 0.15);
    }
    
    .psychology-note--follow_up, .psychology-note--metacognitive, .psychology-note--question {
      border-color:var(--accent);
      background:var(--accent-light);
    }
    
    .psychology-note--CBT {
      border-color:var(--warning);
      background:rgba(246, 173, 85, 0.15);
    }
    
    .psychology-note--safety_crisis {
      border-color:var(--danger);
      background:rgba(240, 128, 128, 0.15);
    }
    
    .taskbar{
      justify-content:center;
      padding:20px;
    }
    
    #timerBox{
      display:inline-flex;
      align-items:center;
      gap:12px;
      background:var(--accent-light);
      padding:8px 16px;
      border-radius:12px;
      border:1px solid var(--accent);
      font-size:15px;
    }
    
    .timer-value{
      font-weight:700;
      color:var(--text-primary);
      font-size:18px;
    }
    
    .chip{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background:var(--accent);
      color:var(--text-primary);
      font-weight:700;
      font-size:13px;
    }
    
    .recording-active{
      animation:pulse 2s infinite;
    }
    
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(221, 234, 109, 0.7)}
      70%{box-shadow:0 0 0 12px rgba(221, 234, 109, 0)}
      100%{box-shadow:0 0 0 0 rgba(221, 234, 109, 0)}
    }
    
    .status-indicator{
      display:inline-block;
      width:10px;
      height:10px;
      border-radius:50%;
      margin-right:8px;
      box-shadow:var(--shadow-sm);
    }
    
    .status-idle{background:#d4d4d8}
    .status-listening{background:#ef4444}
    .status-processing{background:var(--warning)}
    .status-ready{background:var(--success)}
    
    /* --- WELLNESS STYLES --- */
    .card{
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      margin-bottom:24px;
      position:relative;
      box-shadow:var(--shadow-sm);
      transition:var(--transition);
    }
    
    .card:hover{
      box-shadow:var(--shadow-md);
      border-color: #dcdcdc;
    }
    
    .card-header{
      padding:20px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .card-header h3{
      margin:0;
      font-size:18px;
      font-weight:700;
      color:var(--text-primary);
    }
    
    .card-content{
      padding:20px;
    }
    
    .interpret-btn{
      font-size:13px;
      color:var(--accent-dark);
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
      transition:var(--transition);
    }
    
    .interpret-btn:hover{
      text-decoration:underline;
    }
    
    .interpret-text{
      font-size:14px;
      color:var(--text-secondary);
      background:var(--accent-light);
      padding:16px;
      border-radius:12px;
      margin-top:16px;
      line-height:1.6;
    }
    
    .charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(380px,1fr));
      gap:24px;
    }
    
    .hourly-logger{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(60px, 1fr));
      gap:10px;
    }
    
    .hour-btn{
      padding:10px;
      text-align:center;
      border:1px solid var(--border);
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      background:white;
      transition:var(--transition);
      font-weight:600;
      color:var(--text-secondary);
    }
    
    .hour-btn:hover:not(:disabled){
      background:var(--accent-light);
      border-color:var(--accent);
      transform:translateY(-2px);
    }
    
    .hour-btn.logged{
      background:var(--accent);
      color:var(--text-primary);
      border-color:transparent;
    }
    
    .hour-btn:disabled{
      background:#f5f5f4;
      color:#a8a29e;
      cursor:not-allowed;
      border-color:var(--border);
    }
    
    .hour-btn .loader {
      border-top-color:var(--accent);
      width:16px;
      height:16px;
      border-width:2px;
    }
    
    .insights-grid, .goals-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:20px;
    }
    
    .insight-card{
      border-left-width:4px;
      padding:20px;
      border-radius:12px;
      transition:var(--transition);
    }
    
    .insight-card:hover{
      transform:translateX(4px);
    }
    
    .insight-card h4{
      margin-bottom:10px;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .insight-notice{
      background:rgba(246, 173, 85, 0.15);
      border-color:var(--warning);
    }
    
    .insight-notice h4{
      color: #b96a15;
    }
    
    .insight-positive{
      background:rgba(104, 211, 145, 0.15);
      border-color:var(--success);
    }
    
    .insight-positive h4{
      color:#2f6e53;
    }
    
    .insight-negative{
      background:rgba(240, 128, 128, 0.15);
      border-color: var(--danger);
    }
    
    .insight-negative h4{
      color:#a54d4d;
    }
    
    .insight-growth {
      background: rgba(129, 230, 217, 0.2);
      border-color: var(--growth);
    }
    
    .insight-growth h4 {
      color: #2c7a7b;
    }

    .insight-action{
      background:var(--accent-light);
      border-color:var(--accent);
    }
    
    .insight-action h4{
      color:var(--text-primary);
    }
    
    #calendarHeatmap{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      max-width:224px;
    }
    
    .calendar-cell{
      aspect-ratio:1;
      border-radius:6px;
      background:#f5f5f4;
      cursor:pointer;
      position:relative;
      transition:var(--transition);
    }
    
    .calendar-cell:hover{
      border:2px solid var(--accent);
      transform:scale(1.1);
    }
    
    .calendar-cell .tooltip{
      visibility:hidden;
      width:180px;
      background-color:#3d3d3d;
      color:white;
      text-align:center;
      border-radius:8px;
      padding:8px;
      position:absolute;
      z-index:1;
      bottom:125%;
      left:50%;
      margin-left:-90px;
      opacity:0;
      transition:opacity .3s;
      font-size:12px;
    }
    
    .calendar-cell:hover .tooltip{
      visibility:visible;
      opacity:1;
    }
    
    #wordCloudContainer{
      min-height:320px;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .goal-card{
      background:var(--accent-light);
      border:1px solid var(--accent);
      padding:20px;
      border-radius:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      transition:var(--transition);
    }
    
    .goal-card:hover{
      transform:translateY(-4px);
      box-shadow:var(--shadow-md);
    }
    
    .goal-card-content {
      display:flex;
      align-items:center;
      gap:16px;
    }
    
    .goal-card-icon{
      font-size:28px;
    }
    
    .goal-card p{
      margin:0;
      color:var(--text-primary);
      font-weight:600;
      font-size:15px;
    }
    
    .goal-card .rationale {
      font-size:14px;
      color:var(--text-secondary);
      margin-left:44px;
      line-height:1.5;
    }
    
    .daily-reflection-form {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:24px;
    }
    
    .form-group {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    
    .form-group label {
      font-weight:700;
      font-size:15px;
      color:var(--text-primary);
    }
    
    .form-group .options {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    
    .options label {
      font-weight:500;
      font-size:14px;
      background:white;
      padding:8px 16px;
      border-radius:20px;
      cursor:pointer;
      border:1px solid var(--border);
      transition:var(--transition);
      color:var(--text-secondary);
    }
    
    .options label:hover {
      border-color:var(--accent);
      transform:translateY(-2px);
    }
    
    .options input:checked + label {
      background:var(--accent);
      color:var(--text-primary);
      border-color:transparent;
      box-shadow:var(--shadow-sm);
    }
    
    .options input {
      display:none;
    }
    
    .food-group {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 0;
    }
    
    .food-group select {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:white;
      cursor:pointer;
      transition:var(--transition);
    }
    
    .food-group select:focus {
      outline:none;
      border-color:var(--accent);
    }
    
    .session-summary-list {
      max-height:300px;
      overflow-y:auto;
      padding-right:8px;
      list-style:none;
    }
    
    .session-summary-item {
      margin-bottom:16px;
      padding-bottom:16px;
      border-bottom:1px solid var(--border);
    }
    
    .session-summary-item:last-child {
      border-bottom:none;
    }
    
    .session-summary-item h5 {
      font-size:16px;
      font-weight:700;
      color:var(--text-primary);
      margin-bottom:4px;
    }
    
    .session-summary-item p {
      line-height:1.6;
    }
    
    .card-loader-overlay {
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(4px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10;
      border-radius:20px;
    }
    
    footer {
      text-align:center;
      margin-top:40px;
      padding:20px;
      color:var(--text-secondary);
      font-size:14px;
    }
    
    .small {
      font-size:13px;
      color:var(--text-secondary);
    }
    
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
  </style>
</head>
<body>
<div class="container">
    <header>
        <div>
            <h1>HealAura</h1>
            <p class="tagline">An empathetic, metacognitive, and CBT-inspired AI dedicated to nurturing your well-being and supporting you psychologically at every step <br> <b>By GenAURA++</b></p>
        </div>
    </header>
    <div id="authContainer"><!-- Auth Forms --></div>
    <div id="appContainer" class="hidden">
        <div class="controls">
            <button id="showSessionBtn" class="primary">Therapy Session</button>
            <button id="showWellnessBtn">Wellness Tracker</button>
            <button id="logoutBtn" style="margin-left:auto;">Logout</button>
            <button id="endSession" disabled class="danger">End Session</button>
            <div id="sessionId" class="small">(no active session)</div>
        </div>
        <div id="therapySessionContainer"></div>
        <div id="wellnessContainer" class="hidden"></div>
    </div>
    <footer><p>This is a supportive tool, not a replacement for professional mental health care.</p></footer>
</div>

<script>
let currentUserId = null, sessionId = null, mediaRecorder = null, wellnessData = null, activeTask = null, timerInterval = null, timerRemaining = 0;
let audioChunks = [], charts = {};
const dom = {
    authContainer: document.getElementById('authContainer'), appContainer: document.getElementById('appContainer'),
    loginForm: document.getElementById('loginForm'), signupForm: document.getElementById('signupForm'),
    showSignupLink: document.getElementById('showSignupLink'), showLoginLink: document.getElementById('showLoginLink'),
    logoutBtn: document.getElementById('logoutBtn'),
    showSessionBtn: document.getElementById('showSessionBtn'), showWellnessBtn: document.getElementById('showWellnessBtn'),
    therapyContainer: document.getElementById('therapySessionContainer'), wellnessContainer: document.getElementById('wellnessContainer'),
    sessionIdEl: document.getElementById('sessionId'), endSessionBtn: document.getElementById('endSession'),
};

function showAlert(title, message, type = 'info') {
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) existingModal.remove();
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    const typeColor = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--accent-dark)';
    modal.innerHTML = `
        <div class="modal-box">
            <h3 style="color:${typeColor};">${title}</h3>
            <p>${message}</p>
            <div class="modal-actions">
                <button class="primary" onclick="this.closest('.modal-overlay').remove()">OK</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
}

function showLoader(button, isLoading) {
    if(!button) return;
    button.classList.toggle('loading', isLoading);
    button.disabled = isLoading;
}

function toggleInterpret(el) {
    const textEl = el.nextElementSibling;
    textEl.classList.toggle('hidden');
    el.textContent = textEl.classList.contains('hidden') ? 'How to Interpret â–¼' : 'Hide Interpretation â–²';
}

function appendTurn(who, data, meta = null, decision = '') {
    const turnEl = document.createElement('div');
    turnEl.className = `turn ${who}`;
    const avatar = document.createElement('div');
    avatar.className = `avatar avatar-${who}`;
    avatar.textContent = who === 'ai' ? 'AI' : 'You';
    const msgContent = document.createElement('div');
    msgContent.className = 'msg-content';
    const speaker = document.createElement('div');
    speaker.className = 'speaker';
    speaker.textContent = who === 'ai' ? 'AI Therapist' : 'You';
    const msgBubble = document.createElement('div');
    msgBubble.className = 'msg-bubble';
    const replyData = data.reply_structured || {};
    if (who === 'ai' && Array.isArray(replyData.response_parts)) {
        replyData.response_parts.forEach(part => {
            const partEl = document.createElement('div');
            partEl.className = `response-${part.type || 'plain'}`;
            partEl.innerText = part.text;
            msgBubble.appendChild(partEl);
        });
        if (replyData.task_meta?.detail) {
            const instructionsEl = document.createElement('div');
            instructionsEl.className = 'task-instructions';
            const ol = document.createElement('ol');
            const steps = replyData.task_meta.detail.replace(/\d+\.\s*/g, '').split(/;\s*|\.\s*/).filter(s => s.trim());
            steps.forEach(step => { const li = document.createElement('li'); li.textContent = step; ol.appendChild(li); });
            instructionsEl.appendChild(ol);
            msgBubble.appendChild(instructionsEl);
        }
    } else { msgBubble.innerText = data.text || "(no text)"; }
    msgContent.appendChild(speaker);
    msgContent.appendChild(msgBubble);
    if (meta) { const metaEl = document.createElement('div'); metaEl.className = 'meta'; metaEl.textContent = meta; msgContent.appendChild(metaEl); }
    if (who === 'ai' && replyData.psychology_behind_it) {
        const psychEl = document.createElement('div');
        const decisionType = (decision || '').split('+')[1] || (decision || '').split('+')[0];
        psychEl.className = `psychology-note psychology-note--${decisionType}`;
        psychEl.innerText = replyData.psychology_behind_it;
        msgContent.appendChild(psychEl);
    }
    turnEl.appendChild(avatar);
    turnEl.appendChild(msgContent);
    dom.conversation.appendChild(turnEl);
    dom.conversation.scrollTop = dom.conversation.scrollHeight;
    const startTask = () => {
        const timerCard = (replyData.display_cards || []).find(c => c.type === 'timer');
        if (timerCard) {
            const task = { task_id: replyData.task_meta?.task_id || `task_${Date.now()}`, type: replyData.task_meta?.type || 'exercise', detail: replyData.task_meta?.detail || 'Follow spoken instructions.', duration_sec: timerCard.duration_sec };
            startCountdown(timerCard.duration_sec, task);
        }
    };
    if (who === 'ai' && data.tts_b64) {
        try { const audioBlob = new Blob([Uint8Array.from(atob(data.tts_b64), c => c.charCodeAt(0))], { type: 'audio/mpeg' }); const audioUrl = URL.createObjectURL(audioBlob); const audio = new Audio(audioUrl); audio.play().catch(e => { console.warn("TTS playback failed", e); startTask(); }); audio.onended = () => { URL.revokeObjectURL(audioUrl); startTask(); }; } catch (e) { console.warn("TTS processing failed", e); startTask(); }
    } else { startTask(); }
}

function startCountdown(durationSec, task) {
    clearActiveTask();
    timerRemaining = parseInt(durationSec || 0);
    activeTask = task;
    dom.taskControls.classList.remove('hidden');
    if (timerRemaining <= 0) { dom.markDoneBtn.disabled = false; return; }
    dom.timerBox.classList.remove('hidden');
    dom.timerValue.textContent = `${timerRemaining}s`;
    dom.markDoneBtn.disabled = true;
    timerInterval = setInterval(() => {
        timerRemaining -= 1;
        dom.timerValue.textContent = `${timerRemaining}s`;
        if (timerRemaining <= 0) { clearInterval(timerInterval); timerInterval = null; dom.timerValue.textContent = 'Done!'; dom.markDoneBtn.disabled = false; }
    }, 1000);
}

function clearActiveTask() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    if(dom.taskControls) dom.taskControls.classList.add('hidden');
    if(dom.timerBox) dom.timerBox.classList.add('hidden');
    activeTask = null;
    if(dom.markDoneBtn) dom.markDoneBtn.disabled = true;
}

function updateStatus(status, processing=false){
    if(!dom.recStatus || !dom.statusIndicator) return;
    dom.recStatus.textContent = status;
    dom.statusIndicator.className = 'status-indicator';
    if(processing) dom.statusIndicator.classList.add('status-processing');
    else if(status.includes('Recording')) dom.statusIndicator.classList.add('status-listening');
    else dom.statusIndicator.classList.add('status-idle');
}

document.addEventListener('DOMContentLoaded', () => {
    // Populate Auth Container
    dom.authContainer.innerHTML = `<div class="auth-container"><form id="loginForm" class="auth-form"><h2>Welcome Back to HealAura</h2><input type="text" id="loginUsername" name="username" placeholder="Username" required><input type="password" id="loginPassword" name="password" placeholder="Password" required><button type="submit" class="primary"><span class="btn-text">Login</span><div class="loader"></div></button><div class="form-footer">Don't have an account? <a id="showSignupLink">Create one</a></div></form><form id="signupForm" class="auth-form hidden"><h2>Create Your HealAura Account</h2><div style="border:1px solid #f0ad4e; padding:12px; border-radius:6px; background:#fff7e6;">
  <strong>Important:</strong>
  <p style="margin:6px 0 0;">
    This is an anonymous account. We do not collect email or other credentials. <strong>Save your username and password now</strong>; they cannot be recovered later.
  </p>
</div>
<input type="text" id="signupUsername" name="username" placeholder="Username" required><input type="password" id="signupPassword" name="password" placeholder="Password (min 6 chars)" required><input type="password" id="signupConfirmPassword" name="confirm_password" placeholder="Confirm Password" required><button type="submit" class="primary"><span class="btn-text">Create Account</span><div class="loader"></div></button><div class="form-footer">Already have an account? <a id="showLoginLink">Login</a></div></form></div>`;
    // Populate Therapy Container
    dom.therapyContainer.innerHTML = `<div class="session-setup" id="sessionSetup"><div><label for="languageSelect" class="small">Language:</label><select id="languageSelect"><option value="en-US" selected>English</option><option value="hi-IN">Hindi</option></select></div><div class="gender-options"><span>Your Gender:</span><div class="gender-btn"><input type="radio" name="userGender" value="female" id="genderF" checked><label for="genderF">Female</label></div><div class="gender-btn"><input type="radio" name="userGender" value="male" id="genderM"><label for="genderM">Male</label></div><div class="gender-btn"><input type="radio" name="userGender" value="other" id="genderO"><label for="genderO">Other</label></div></div><button id="startSession" class="primary" style="margin-left: auto;"><span class="btn-text">Start New Session</span><div class="loader"></div></button></div><div class="recording hidden" id="recordingControls"><button id="startRec">Start Recording</button><button id="stopRec" disabled class="danger">Stop Recording</button><button id="submitRec" disabled class="primary"><span class="btn-text">Submit</span><div class="loader"></div></button><div style="margin-left: auto; display: flex; align-items: center; gap: 6px;"><span class="status-indicator status-idle" id="statusIndicator"></span><span id="recStatus" class="small">Ready</span></div></div><div id="conversation"></div><div class="taskbar hidden" id="taskControls"><button id="markDone" class="success" disabled><span class="btn-text">I'm Done</span><div class="loader"></div></button><div id="timerBox" class="hidden"><span class="chip">Timer</span><span class="timer-value" id="timerValue">60s</span></div></div>`;
    // Populate Wellness Container
    dom.wellnessContainer.innerHTML = `
        <h2 style="font-size:26px; margin-bottom:24px; color:var(--text-primary);">Your Wellness Dashboard</h2>
        <div class="card"><div class="card-header"><h3>Daily Logging</h3></div><div class="card-content">
            <h4>Part 1: Quick Thoughts</h4><p class="small" style="margin-bottom:16px;">How are you feeling? Click an hour to log your thoughts and emotions. Logged hours are disabled.</p><div class="hourly-logger" id="hourlyLogger"></div>
            <hr style="margin: 28px 0; border: none; border-top: 1px solid var(--border);">
            <h4>Part 2: Daily Reflection</h4><p class="small" style="margin-bottom:16px;">Fill this out once per day to find deeper patterns.</p><form id="dailyReflectionForm" class="daily-reflection-form"></form>
        </div></div>
        <div class="card"><div class="card-header"><h3>This Week's Goals</h3></div><div class="card-content goals-grid" id="goalsContainer"></div></div>
        <div class="card"><div class="card-header"><h3>AI-Powered Insights</h3></div><div class="card-content"><div class="insights-grid" id="insightsContainer"></div></div></div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Sleep Quality vs. Sentiment</h3></div><div class="card-content"><canvas id="sleepChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret â–¼</a><div class="interpret-text hidden">This chart shows your average mood based on sleep quality. For example, a high bar for "Good" sleep suggests that when you sleep well, you tend to feel better.</div></div></div>
            <div class="card"><div class="card-header"><h3>Activity vs. Sentiment</h3></div><div class="card-content"><canvas id="activityChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret â–¼</a><div class="interpret-text hidden">This compares how different activities correlate with your mood. It can help you identify which activities are restorative and which might be draining.</div></div></div>
        </div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Social vs. Sentiment</h3></div><div class="card-content"><canvas id="socialChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret â–¼</a><div class="interpret-text hidden">This chart shows the connection between who you spend time with and your overall mood, helping you understand your social energy.</div></div></div>
            <div class="card"><div class="card-header"><h3>Sentiment Over Time</h3></div><div class="card-content"><canvas id="sentimentOverTimeChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret â–¼</a><div class="interpret-text hidden">This line chart tracks your average daily mood. Upward trends indicate periods of positivity, while downward trends might highlight challenging times. It helps you see your emotional journey at a glance.</div></div></div>
        </div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Emotion Distribution</h3></div><div class="card-content"><canvas id="emotionDistributionChart"></canvas><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret â–¼</a><div class="interpret-text hidden">This chart shows the percentage of each emotion you've logged. It gives a high-level overview of your most frequent feelings. Are there any surprises here?</div></div></div>
            <div class="card"><div class="card-header"><h3>Topic Word Cloud</h3></div><div class="card-content"><div id="wordCloudContainer"></div><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret â–¼</a><div class="interpret-text hidden">The bigger the word, the more often it appears in your logs. This helps you quickly see the topics that are on your mind the most, offering clues about what drives your emotions.</div></div></div>
        </div>
        <div class="charts-grid">
            <div class="card"><div class="card-header"><h3>Daily Sentiment (Last 30 Days)</h3></div><div class="card-content"><div id="calendarHeatmap"></div><a class="interpret-btn" onclick="toggleInterpret(this)">How to Interpret â–¼</a><div class="interpret-text hidden">Greener days are more positive, redder days are more negative. Click any day to get an AI-generated summary of your logs for that day.</div></div></div>
            <div class="card"><div class="card-header"><h3>Recent Session Summaries</h3></div><div class="card-content"><ul class="session-summary-list" id="sessionSummaryList">(No session summaries found)</ul></div></div>
        </div>
        `;

    // Re-assign all DOM elements
    Object.assign(dom, {
        loginForm: document.getElementById('loginForm'), signupForm: document.getElementById('signupForm'), showSignupLink: document.getElementById('showSignupLink'), showLoginLink: document.getElementById('showLoginLink'), sessionSetup: document.getElementById('sessionSetup'), languageSelect: document.getElementById('languageSelect'), startSessionBtn: document.getElementById('startSession'), recordingControls: document.getElementById('recordingControls'), startRecBtn: document.getElementById('startRec'), stopRecBtn: document.getElementById('stopRec'), submitRecBtn: document.getElementById('submitRec'), conversation: document.getElementById('conversation'), statusIndicator: document.getElementById('statusIndicator'), recStatus: document.getElementById('recStatus'), taskControls: document.getElementById('taskControls'), markDoneBtn: document.getElementById('markDone'), timerBox: document.getElementById('timerBox'), timerValue: document.getElementById('timerValue'), hourlyLogger: document.getElementById('hourlyLogger'), insightsContainer: document.getElementById('insightsContainer'), goalsContainer: document.getElementById('goalsContainer'), dailyReflectionForm: document.getElementById('dailyReflectionForm'), sessionSummaryList: document.getElementById('sessionSummaryList'), calendarHeatmap: document.getElementById('calendarHeatmap'), wordCloudContainer: document.getElementById('wordCloudContainer')
    });
    
    // Attach event listeners
    dom.showSignupLink.onclick = () => { dom.loginForm.classList.add('hidden'); dom.signupForm.classList.remove('hidden'); };
    dom.showLoginLink.onclick = () => { dom.signupForm.classList.add('hidden'); dom.loginForm.classList.remove('hidden'); };
    dom.signupForm.onsubmit = onSignup;
    dom.loginForm.onsubmit = onLogin;
    dom.logoutBtn.onclick = onLogout;
    dom.showSessionBtn.onclick = () => { dom.therapyContainer.classList.remove('hidden'); dom.wellnessContainer.classList.add('hidden'); dom.showSessionBtn.classList.add('primary'); dom.showWellnessBtn.classList.remove('primary'); };
    dom.showWellnessBtn.onclick = () => { dom.therapyContainer.classList.add('hidden'); dom.wellnessContainer.classList.remove('hidden'); dom.showWellnessBtn.classList.add('primary'); dom.showSessionBtn.classList.remove('primary'); if (!wellnessData) fetchAndRenderWellnessData(); };
    dom.startSessionBtn.onclick = onStartSession;
    dom.endSessionBtn.onclick = onEndSession;
    dom.startRecBtn.onclick = onStartRecording;
    dom.stopRecBtn.onclick = onStopRecording;
    dom.submitRecBtn.onclick = onSubmitRecording;
    dom.markDoneBtn.onclick = onTaskDone;
    dom.dailyReflectionForm.onsubmit = onSaveStructuredData;
});

// --- AUTH & SESSION FUNCTIONS ---
async function onSignup(e) { e.preventDefault(); const btn = dom.signupForm.querySelector('button'); showLoader(btn, true); try { const form = new FormData(dom.signupForm); const res = await fetch('/signup', { method: 'POST', body: form }); const data = await res.json(); if (!res.ok) throw new Error(data.detail); showAlert('Success', 'Account created. Please log in.', 'success'); dom.signupForm.reset(); dom.showLoginLink.onclick(); } catch (err) { showAlert('Signup Error', err.message, 'error'); } finally { showLoader(btn, false); } }
async function onLogin(e) { e.preventDefault(); const btn = dom.loginForm.querySelector('button'); showLoader(btn, true); try { const form = new FormData(dom.loginForm); const res = await fetch('/login', { method: 'POST', body: form }); const data = await res.json(); if (!res.ok) throw new Error(data.detail); currentUserId = data.user_id; dom.authContainer.classList.add('hidden'); dom.appContainer.classList.remove('hidden'); dom.showSessionBtn.click(); } catch (err) { showAlert('Login Error', err.message, 'error'); } finally { showLoader(btn, false); } }
function onLogout() { if(sessionId) onEndSession(); currentUserId=null; sessionId=null; wellnessData=null; dom.appContainer.classList.add('hidden'); dom.authContainer.classList.remove('hidden'); dom.loginForm.reset(); dom.signupForm.reset(); dom.conversation.innerHTML=''; dom.endSessionBtn.disabled=true; clearActiveTask(); }
async function onStartSession() { showLoader(dom.startSessionBtn, true); updateStatus("Starting...", true); try { const form=new FormData(); form.append('user_id', currentUserId); form.append('language', dom.languageSelect.value); form.append('user_gender', document.querySelector('input[name="userGender"]:checked').value); const res = await fetch('/start_session', {method:'POST', body: form}); if(!res.ok) throw new Error(await res.text()); const j = await res.json(); sessionId = j.session_id; dom.sessionSetup.classList.add('hidden'); dom.recordingControls.classList.remove('hidden'); dom.sessionIdEl.textContent = `Session: ...${sessionId.slice(-6)}`; dom.conversation.innerHTML = ""; appendTurn('ai', { reply_structured: j.initial_reply, tts_b64: j.tts_b64 }, null, "start"); dom.endSessionBtn.disabled = false; wellnessData = null; clearActiveTask(); updateStatus("Ready", false); } catch(e) { showAlert('Error', e.message, 'error'); updateStatus("Error", false); } finally { showLoader(dom.startSessionBtn, false); } }
async function onEndSession() { if(!sessionId) return; showLoader(dom.endSessionBtn, true); updateStatus("Ending...", true); try { const form=new FormData(); form.append('session_id', sessionId); const res = await fetch('/end_session',{method:'POST',body:form}); const j = await res.json(); appendTurn('ai',{reply_structured: j.closing_reply,tts_b64:j.tts_b64}, null, "end"); sessionId=null; dom.sessionIdEl.textContent="(no active session)"; dom.sessionSetup.classList.remove('hidden'); dom.recordingControls.classList.add('hidden'); dom.endSessionBtn.disabled=true; clearActiveTask();} catch(e) { showAlert('Error', `Could not end session: ${e.message}`, 'error'); } finally { showLoader(dom.endSessionBtn, false); updateStatus("Ended", false); } }
async function onStartRecording() { updateStatus("Requesting mic...", true); audioChunks = []; try { const stream = await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder = new MediaRecorder(stream); mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); }; mediaRecorder.onstop = () => { updateStatus("Stopped", false); dom.submitRecBtn.disabled = false; }; mediaRecorder.start(); dom.startRecBtn.disabled = true; dom.stopRecBtn.disabled = false; dom.startRecBtn.classList.add('recording-active'); updateStatus("Recording...", false); } catch (e) { showAlert('Mic Error', e.message, 'error'); updateStatus("Mic Error", false); } }
function onStopRecording() { if(mediaRecorder?.state === "recording"){ mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t => t.stop()); dom.startRecBtn.disabled = false; dom.stopRecBtn.disabled = true; dom.startRecBtn.classList.remove('recording-active'); } }
async function onSubmitRecording() {
    if (!audioChunks.length || !sessionId) return;
    showLoader(dom.submitRecBtn, true);
    updateStatus("Processing...", true);
    try {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const form = new FormData();
        form.append('file', blob, 'rec.webm');
        form.append('session_id', sessionId);
        const res = await fetch('/process_audio', { method: 'POST', body: form });
        if (!res.ok) throw new Error((await res.json()).detail);
        const j = await res.json();
        appendTurn('user', { text: j.audio_output.transcript || "(silence)" });
        appendTurn('ai', { reply_structured: j.reply, tts_b64: j.tts_b64 }, null, j.decision.decision);
        audioChunks = [];
        dom.submitRecBtn.disabled = true;
    } catch (e) {
        showAlert('Error', e.message, 'error');
    } finally {
        showLoader(dom.submitRecBtn, false);
        updateStatus("Ready", false);
    }
}
async function onTaskDone() {
    if (!sessionId || !activeTask) return;
    showLoader(dom.markDoneBtn, true);
    try {
        const form = new FormData();
        form.append('session_id', sessionId);
        form.append('task_id', activeTask.task_id);
        const res = await fetch('/task_done', { method: 'POST', body: form });
        if (!res.ok) throw new Error(await res.text());
        const j = await res.json();
        appendTurn('ai', { reply_structured: j.reply, tts_b64: j.tts_b64 }, null, j.decision.decision);
    } catch (e) {
        showAlert('Task Error', e.message, 'error');
    } finally {
        showLoader(dom.markDoneBtn, false);
        clearActiveTask();
    }
}
async function onSaveStructuredData(e) { e.preventDefault(); const btn = dom.dailyReflectionForm.querySelector('button'); showLoader(btn, true); try { const form = new FormData(dom.dailyReflectionForm); form.append('user_id', currentUserId); form.append('date_str', new Date().toISOString().split('T')[0]); const res = await fetch('/wellness/log_structured_entry', { method: 'POST', body: form }); if (!res.ok) throw new Error(await res.text()); showAlert('Success', 'Reflection saved.', 'success'); wellnessData = null; fetchAndRenderWellnessData(); } catch(e) { showAlert('Error', e.message, 'error'); } finally { showLoader(btn, false); } }

// --- WELLNESS DASHBOARD FUNCTIONS ---
async function fetchAndRenderWellnessData() {
    showLoader(dom.showWellnessBtn, true);
    const wellnessCards = dom.wellnessContainer.querySelectorAll('.card');
    wellnessCards.forEach(card => {
        const overlay = document.createElement('div');
        overlay.className = 'card-loader-overlay';
        overlay.innerHTML = `<div class="loader" style="display:block; width: 40px; height: 40px; border-width: 4px;"></div>`;
        card.appendChild(overlay);
    });

    try {
        const form = new FormData(); form.append('user_id', currentUserId);
        const res = await fetch('/wellness/get_wellness_data', { method: 'POST', body: form });
        if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Failed to fetch data.'); }
        wellnessData = await res.json();
        const { raw_logs, summaries, aggregated_data, insights } = wellnessData;
        renderDailyLogging(raw_logs);
        renderSummaries(summaries);
        renderInsights(insights);
        renderGoals(insights.weekly_goals);
        renderCalendarHeatmap(aggregated_data.daily_sentiment);
        renderAllCharts(aggregated_data);
    } catch (e) { showAlert('Dashboard Error', e.message, 'error'); } 
    finally { 
        showLoader(dom.showWellnessBtn, false); 
        wellnessCards.forEach(card => {
            const overlay = card.querySelector('.card-loader-overlay');
            if (overlay) overlay.remove();
        });
    }
}

function renderDailyLogging(logs) {
    dom.hourlyLogger.innerHTML = '';
    const todayStr = new Date().toISOString().split('T')[0];
    const todaysTextLogs = logs.filter(l => l.type === 'hourly_text' && l.log_date_local === todayStr);
    for (let i = 0; i < 24; i++) {
        const btn = document.createElement('button');
        btn.className = 'hour-btn';
        btn.innerHTML = `<span class="btn-text">${i}:00</span><div class="loader"></div>`; 
        const existingLog = todaysTextLogs.find(l => l.log_hour_local === i);
        if (existingLog) { btn.classList.add('logged'); btn.title = `Logged: ${existingLog.analysis.primary_emotion}`; btn.disabled = true; }
        btn.onclick = (e) => logForHour(i, existingLog, e.currentTarget);
        dom.hourlyLogger.appendChild(btn);
    }
    const todaysStructuredLog = logs.find(l => l.type === 'structured' && l.log_date_local === todayStr);
    renderStructuredForm(todaysStructuredLog);
}

function logForHour(hour, existingLog, buttonEl) { const text = prompt(`How are you feeling at ${hour}:00?`); if (text?.trim()) submitHourlyLog(hour, text.trim(), buttonEl); }

async function submitHourlyLog(hour, text, buttonEl) { 
    showLoader(buttonEl, true);
    const form = new FormData(); 
    form.append('user_id', currentUserId); 
    form.append('hour', hour); 
    form.append('text', text); 
    
    // FIX: Use local date to prevent timezone errors in the evening.
    const now = new Date();
    const localDateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    form.append('date_str', localDateStr);
    
    try { 
        const res = await fetch('/wellness/log_daily_entry', { method: 'POST', body: form }); 
        if (!res.ok) {
             const errorData = await res.json();
             throw new Error(errorData.detail || 'Failed to submit log.');
        }
        const result = await res.json();
        const newLog = result.data;

        buttonEl.classList.add('logged');
        buttonEl.disabled = true;
        buttonEl.title = `Logged: ${newLog.analysis.primary_emotion}`;
        
        if (wellnessData && wellnessData.raw_logs) {
            wellnessData.raw_logs.push(newLog);
        }
    } catch(e) { 
        showAlert('Log Error', e.message, 'error'); 
    } finally {
        showLoader(buttonEl, false);
    }
}

function renderSummaries(summaries) { dom.sessionSummaryList.innerHTML = (!summaries || summaries.length === 0) ? '<li>(No recent session summaries)</li>' : summaries.map(s => `<li class="session-summary-item"><h5>${s.title || 'Session Summary'}</h5><p class="small">${new Date(s.session_start_utc).toLocaleString()}</p><p style="font-size: 14px;">${s.overall_summary || ''}</p></li>`).join(''); }

function renderStructuredForm(log) {
    const data = log ? log.data : {};
    const social = data.social_interactions || [];
    const activities = data.activities || [];
    const food = data.food_intake || {};
    const fields = {
        sleep_quality: { label: 'How was your sleep quality?', options: ['Good', 'OK', 'Poor'], type: 'radio' },
        social_interactions: { label: 'Who did you spend most time with?', options: ['Family', 'Partner', 'Friends', 'Alone'], type: 'checkbox' },
        activities: { label: 'What activities did you do?', options: ['Work', 'Exercise', 'Hobby', 'Relax', 'Lazy'], type: 'checkbox' }
    };
    let formHTML = '';
    for (const [key, val] of Object.entries(fields)) {
        formHTML += `<div class="form-group"><label>${val.label}</label><div class="options">`;
        val.options.forEach(opt => {
            const checked = val.type === 'radio' ? (data[key] === opt ? 'checked' : '') : (data[key]?.includes(opt) ? 'checked' : '');
            formHTML += `<input type="${val.type}" name="${key}" value="${opt}" id="${key}_${opt}" ${checked} ${log ? 'disabled' : ''}><label for="${key}_${opt}">${opt}</label>`;
        });
        formHTML += `</div></div>`;
    }
    formHTML += `<div class="form-group"><label>Food Intake Quality</label>
        <div class="food-group"><span>Breakfast:</span> <select name="food_breakfast" ${log ? 'disabled' : ''}><option ${food.breakfast === 'Healthy' ? 'selected' : ''}>Healthy</option><option ${food.breakfast === 'Semi' ? 'selected' : ''}>Semi</option><option ${food.breakfast === 'Junk' ? 'selected' : ''}>Junk</option></select></div>
        <div class="food-group"><span>Lunch:</span> <select name="food_lunch" ${log ? 'disabled' : ''}><option ${food.lunch === 'Healthy' ? 'selected' : ''}>Healthy</option><option ${food.lunch === 'Semi' ? 'selected' : ''}>Semi</option><option ${food.lunch === 'Junk' ? 'selected' : ''}>Junk</option></select></div>
        <div class="food-group"><span>Dinner:</span> <select name="food_dinner" ${log ? 'disabled' : ''}><option ${food.dinner === 'Healthy' ? 'selected' : ''}>Healthy</option><option ${food.dinner === 'Semi' ? 'selected' : ''}>Semi</option><option ${food.dinner === 'Junk' ? 'selected' : ''}>Junk</option></select></div>
    </div>`;
    if (!log) { formHTML += `<button type="submit" class="primary" style="grid-column: 1 / -1; margin-top: 16px;"><span class="btn-text">Save Daily Reflection</span><div class="loader"></div></button>`; } 
    else { formHTML += `<p style="grid-column: 1 / -1; text-align: center; color: var(--muted); margin-top: 16px;">Today's reflection has been saved.</p>`; }
    dom.dailyReflectionForm.innerHTML = formHTML;
}

function renderInsights(insights) { 
    dom.insightsContainer.innerHTML = `
        <div class="insight-card insight-notice"><h4>âœ¨ We've Noticed...</h4><p>${insights.causal_inference || 'N/A'}</p></div>
        <div class="insight-card insight-positive"><h4>âœ… Positive Pattern</h4><p>${insights.positive_pattern || 'N/A'}</p></div>
        <div class="insight-card insight-negative"><h4>âš ï¸ Challenge Pattern</h4><p>${insights.challenge_pattern || 'N/A'}</p></div>
        <div class="insight-card insight-growth"><h4>ðŸŒ± Area for Growth</h4><p>${insights.area_for_growth || 'N/A'}</p></div>
        <div class="insight-card insight-action" style="grid-column: 1 / -1;"><h4>ðŸ’¡ Actionable Suggestion</h4><p>${insights.actionable_suggestion || 'N/A'}</p></div>`;
}

function renderGoals(goals) { 
    dom.goalsContainer.innerHTML = (goals && goals.length > 0) ? goals.map(g => `
        <div class="goal-card">
            <div class="goal-card-content">
                <span class="goal-card-icon">ðŸŽ¯</span>
                <p>${g.goal}</p>
            </div>
            ${g.rationale ? `<div class="rationale">${g.rationale}</div>` : ''}
        </div>`).join('') : '<p>Your personalized goals will appear here soon.</p>'; 
}

const getSentimentColor = s => { if (s === null || s === undefined) return '#f5f5f4'; const g = s > 0 ? 234 : 128, b = s > 0 ? 109 : 128, r = s < 0 ? 240 : 221; const a = Math.abs(s) * .8 + .2; return `rgba(${r}, ${g}, ${b}, ${a})`; };
async function renderCalendarHeatmap(dailySentiments) {
    dom.calendarHeatmap.innerHTML = '';
    const today = new Date();
    const startDate = new Date();
    startDate.setDate(today.getDate() - 29);
    for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        cell.style.backgroundColor = getSentimentColor(dailySentiments[dateStr]);
        cell.onclick = async () => {
            const logsForDay = (wellnessData.raw_logs || []).filter(l => l.type === 'hourly_text' && l.log_date_local === dateStr);
            showAlert(`Summary for ${dateStr}`, 'Generating summary...', 'info');
            try {
                const res = await fetch('/wellness/summarize_day_logs', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: currentUserId, logs: logsForDay }) });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                showAlert(`Summary for ${dateStr}`, data.summary, 'info');
            } catch (e) { showAlert('Error', `Could not generate summary: ${e.message}`, 'error'); }
        };
        cell.innerHTML = `<span class="tooltip">${dateStr}<br>Sentiment: ${dailySentiments[dateStr]?.toFixed(2) || 'N/A'}<br><b>Click for summary</b></span>`;
        dom.calendarHeatmap.appendChild(cell);
    }
}
function renderAllCharts(aggregated) {
    const chartColors = ['#ddea6d', '#68d391', '#f6ad55', '#7180d4', '#b794f4', '#4fd1c5', '#f687b3', '#a3aed2'];
    const correlationMetrics = aggregated.correlation_metrics || {};

    renderCorrelationChart('sleepChart', correlationMetrics.sleep_quality, 'Avg. Sentiment by Sleep Quality', chartColors);
    renderCorrelationChart('activityChart', correlationMetrics.activity, 'Avg. Sentiment by Activity', chartColors);
    renderCorrelationChart('socialChart', correlationMetrics.social, 'Avg. Sentiment by Social Interaction', chartColors);

    if (charts.emotion) charts.emotion.destroy();
    const emotionCtx = document.getElementById('emotionDistributionChart').getContext('2d');
    const emotionData = aggregated.emotion_counts || {};
    charts.emotion = new Chart(emotionCtx, { type: 'pie', data: { labels: Object.keys(emotionData), datasets: [{ data: Object.values(emotionData), backgroundColor: chartColors }] }});

    if (charts.sentiment) charts.sentiment.destroy();
    const sentimentCtx = document.getElementById('sentimentOverTimeChart').getContext('2d');
    const dailyData = aggregated.daily_sentiment || {};
    const sortedDates = Object.keys(dailyData).sort();
    charts.sentiment = new Chart(sentimentCtx, { type: 'line', data: { labels: sortedDates, datasets: [{ label: 'Average Sentiment', data: sortedDates.map(d => dailyData[d]), borderColor: '#c8d75a', tension: 0.1, fill: false, borderWidth: 3 }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { min: -1, max: 1 } } } });
    
    dom.wordCloudContainer.innerHTML = '';
    const words = (aggregated.word_cloud_data || []).map(d => ({text: d.text, size: 10 + Math.pow(d.value, 0.7) * 10}));
    if (words.length > 0) {
        const color = d3.scaleOrdinal(chartColors);
        const layout = d3.layout.cloud().size([dom.wordCloudContainer.clientWidth > 0 ? dom.wordCloudContainer.clientWidth : 300, 300]).words(words).padding(5).rotate(() => 0).fontSize(d => d.size).on("end", draw);
        layout.start();
        function draw(words) { d3.select("#wordCloudContainer").append("svg").attr("width", layout.size()[0]).attr("height", layout.size()[1]).append("g").attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")").selectAll("text").data(words).enter().append("text").style("font-size", d => d.size + "px").style("font-family", "Inter").style("fill", (d,i) => color(i)).attr("text-anchor", "middle").attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")").text(d => d.text); }
    }
}
function renderCorrelationChart(canvasId, data, label, colors) {
    if(!data || Object.keys(data).length === 0) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();
        ctx.font = "14px Inter";
        ctx.fillStyle = "#a8a29e";
        ctx.textAlign = "center";
        ctx.fillText("Not enough data to show this chart yet.", ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    };
    if (charts[canvasId]) charts[canvasId].destroy();
    const ctx = document.getElementById(canvasId).getContext('2d');
    charts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(data), datasets: [{ label: label, data: Object.values(data), backgroundColor: colors }] }, options: { scales: { y: { min: -1, max: 1 } }, indexAxis: 'y', plugins: { legend: { display: false } } } });
}
</script>
</body>
</html>